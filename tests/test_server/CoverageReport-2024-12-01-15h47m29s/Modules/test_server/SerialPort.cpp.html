<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>SerialPort.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
/**
 * @file SerialPort.cpp
 * @brief Implementation of the serial port communication functions.
 */
#include "SerialPort.h"
#include &lt;iostream&gt;
#include &lt;nlohmann/json.hpp&gt;
#include &lt;windows.h&gt;
#include &lt;string&gt;

HANDLE hConsole;
<span style = "background-color:#dfd">std::string port;</span>
int baudRate;
#include &lt;gtest/gtest.h&gt;
#include &lt;fstream&gt;
#include &lt;sstream&gt;
#include &lt;string&gt;
#include "SerialPort.h"  // Ïîòð³áíî ï³äêëþ÷èòè ôàéë ç âèçíà÷åííÿì ôóíêö³¿ loadConfig
#include &lt;nlohmann/json.hpp&gt;  // Ïîòð³áíî ï³äêëþ÷èòè á³áë³îòåêó äëÿ ðîáîòè ç JSON

using json = nlohmann::json;

// Òåñòîâèé êëàñ
class ConfigTest : public ::testing::Test {
protected:
    // Î÷èùàºìî ãëîáàëüí³ çì³íí³ ïåðåä êîæíèì òåñòîì
<span style = "background-color:#dfd">    void SetUp() override {
        port.clear();
        baudRate = 0;
    }</span>

    // Øëÿõ äî òèì÷àñîâîãî ôàéëó êîíô³ãóðàö³¿
    const std::string configFile = "test_config.json";

    // Ôóíêö³ÿ äëÿ ñòâîðåííÿ êîíô³ãóðàö³éíîãî ôàéëó ç ïåðåäàíèì êîíòåíòîì
<span style = "background-color:#dfd">    void createConfigFile(const std::string&amp; content) {
        std::ofstream file(configFile);
        file &lt;&lt; content;
        file.close();
    }</span>

    // Ãëîáàëüí³ çì³íí³, ùî áóäóòü çì³íþâàòèñÿ â loadConfig
    std::string port;
    int baudRate = 0;
};

// Òåñò äëÿ âèïàäêó, êîëè ôàéë íå ³ñíóº
<span style = "background-color:#dfd">TEST_F(ConfigTest, TestLoadConfigFileNotFound) {
    const std::string invalidFile = "non_existent_config.json";</span>

<span style = "background-color:#dfd">    loadConfig(invalidFile); // Ñïðîáóºìî çàâàíòàæèòè íå³ñíóþ÷èé ôàéë</span>

    // Î÷³êóºìî, ùî ïîðò ³ baudRate çàëèøàòüñÿ íåçì³ííèìè
<span style = "background-color:#dfd">    EXPECT_EQ(port, "");
    EXPECT_EQ(baudRate, 0);
}</span>

// Òåñò äëÿ âèïàäêó íåêîðåêòíîãî ôîðìàòó JSON
<span style = "background-color:#dfd">TEST_F(ConfigTest, TestLoadConfigInvalidJSON) {
    std::string invalidConfig = R"(</span>
    {
        "Connection": {
            "port": "COM3",
            "baudRate": "not_a_number"
        }
    })";

<span style = "background-color:#dfd">    createConfigFile(invalidConfig); // Ñòâîðþºìî íåêîðåêòíèé êîíô³ãóðàö³éíèé ôàéë</span>

<span style = "background-color:#dfd">    loadConfig(configFile);  // Çàâàíòàæóºìî êîíô³ãóðàö³þ</span>

    // Î÷³êóºìî, ùî ïîðò ³ baudRate çàëèøàòüñÿ íåçì³ííèìè
<span style = "background-color:#dfd">    EXPECT_EQ(port, "");
    EXPECT_EQ(baudRate, 0);
}</span>

// Òåñò äëÿ âèïàäêó, êîëè ïîðò àáî baudRate â³äñóòí³ àáî íóëüîâ³
<span style = "background-color:#dfd">TEST_F(ConfigTest, TestLoadConfigMissingFields) {
    std::string missingFieldsConfig = R"(</span>
    {
        "Connection": {
            "port": "",
            "baudRate": 0
        }
    })";

<span style = "background-color:#dfd">    createConfigFile(missingFieldsConfig); // Ñòâîðþºìî êîíô³ãóðàö³éíèé ôàéë ç ïîðîæí³ìè ïîëÿìè</span>

<span style = "background-color:#dfd">    loadConfig(configFile);  // Çàâàíòàæóºìî êîíô³ãóðàö³þ</span>

    // Î÷³êóºìî, ùî ïîðò ³ baudRate çàëèøàòüñÿ íåçì³ííèìè
<span style = "background-color:#dfd">    EXPECT_EQ(port, "");
    EXPECT_EQ(baudRate, 0);
}</span>

// Òåñò äëÿ íåêîðåêòíîãî ôîðìàòó JSON (ïîðóøåííÿ ñòðóêòóðè)
<span style = "background-color:#dfd">TEST_F(ConfigTest, TestLoadConfigMalformedJSON) {
    std::string malformedConfig = R"(</span>
    {
        "Connection": {
            "port": "COM3"
            "baudRate": 9600
        }
    })"; // Â³äñóòíÿ êîìà ì³æ ïîëÿìè

<span style = "background-color:#dfd">    createConfigFile(malformedConfig); // Ñòâîðþºìî íåêîðåêòíèé êîíô³ãóðàö³éíèé ôàéë</span>

<span style = "background-color:#dfd">    loadConfig(configFile);  // Çàâàíòàæóºìî êîíô³ãóðàö³þ</span>

    // Î÷³êóºìî, ùî ïîðò ³ baudRate çàëèøàòüñÿ íåçì³ííèìè
<span style = "background-color:#dfd">    EXPECT_EQ(port, "");
    EXPECT_EQ(baudRate, 0);
}</span>

// Î÷èùàºìî ôàéë ï³ñëÿ òåñò³â
<span style = "background-color:#dfd">TEST_F(ConfigTest, TearDown) {
    std::remove(configFile.c_str());  // Âèäàëÿºìî òèì÷àñîâèé ôàéë
}</span>


<span style = "background-color:#dfd">bool SerialCommunication::connect(const std::string&amp; portName, int baudRate) {
    std::wstring widePortName(portName.begin(), portName.end());
    LPCWSTR lpPortName = widePortName.c_str();</span>

<span style = "background-color:#dfd">    hSerial = CreateFile(lpPortName, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
    if (hSerial == INVALID_HANDLE_VALUE) {</span>
<span style = "background-color:#fdd">        std::cerr &lt;&lt; "The serial port is not open: " &lt;&lt; portName &lt;&lt; std::endl;
        return false;</span>
    }

<span style = "background-color:#dfd">    DCB dcb = { 0 };
    dcb.DCBlength = sizeof(dcb);
    dcb.BaudRate = baudRate;
    dcb.ByteSize = 8;
    dcb.StopBits = ONESTOPBIT;
    dcb.Parity = NOPARITY;</span>

<span style = "background-color:#dfd">    if (!SetCommState(hSerial, &amp;dcb)) {</span>
<span style = "background-color:#fdd">        std::cerr &lt;&lt; "The serial port is not open!" &lt;&lt; std::endl;
        CloseHandle(hSerial);
        return false;</span>
    }

<span style = "background-color:#dfd">    COMMTIMEOUTS timeouts = { 0 };
    timeouts.ReadIntervalTimeout = 50;
    timeouts.ReadTotalTimeoutConstant = 50;
    timeouts.ReadTotalTimeoutMultiplier = 10;
    timeouts.WriteTotalTimeoutConstant = 50;
    timeouts.WriteTotalTimeoutMultiplier = 10;</span>

<span style = "background-color:#dfd">    if (!SetCommTimeouts(hSerial, &amp;timeouts)) {</span>
<span style = "background-color:#fdd">        std::cerr &lt;&lt; "Communication timeouts could not be set!" &lt;&lt; std::endl;
        CloseHandle(hSerial);
        return false;</span>
    }

<span style = "background-color:#dfd">    return true;
}</span>

<span style = "background-color:#dfd">void SerialCommunication::disconnect() {
    if (hSerial != INVALID_HANDLE_VALUE) {
        CloseHandle(hSerial);
        hSerial = INVALID_HANDLE_VALUE;</span>
    }
<span style = "background-color:#dfd">}</span>

<span style = "background-color:#dfd">std::string SerialCommunication::sendMessage(const std::string&amp; message) {
    if (hSerial == INVALID_HANDLE_VALUE) {</span>
<span style = "background-color:#fdd">        std::cerr &lt;&lt; "The serial port is not open!" &lt;&lt; std::endl;
        return "";</span>
    }

    DWORD bytesWritten;
<span style = "background-color:#dfd">    if (!WriteFile(hSerial, message.c_str(), message.size(), &amp;bytesWritten, nullptr)) {</span>
<span style = "background-color:#fdd">        std::cerr &lt;&lt; "Unable to read from the serial port!" &lt;&lt; std::endl;
        return "";</span>
    }

    char buffer[256];
    DWORD bytesRead;
<span style = "background-color:#dfd">    if (!ReadFile(hSerial, buffer, sizeof(buffer) - 1, &amp;bytesRead, nullptr)) {</span>
<span style = "background-color:#fdd">        std::cerr &lt;&lt; "Unable to read from the serial port!" &lt;&lt; std::endl;
        return "";</span>
    }
<span style = "background-color:#dfd">    buffer[bytesRead] = '\0';</span>

<span style = "background-color:#dfd">    return std::string(buffer);
}</span>

<span style = "background-color:#dfd">void SerialCommunication::drawBoard(const std::string&amp; boardState) {
    std::cout &lt;&lt; "-------------\n";
    for (int i = 0; i &lt; 3; i++) {
        std::cout &lt;&lt; "| ";
        for (int j = 0; j &lt; 3; j++) {
            char cell = boardState[i * 3 + j];
            if (cell == 'X' || cell == 'O') {
                std::cout &lt;&lt; cell &lt;&lt; " | ";
            }</span>
            else {
<span style = "background-color:#dfd">                std::cout &lt;&lt; " " &lt;&lt; " | ";</span>
            }
<span style = "background-color:#dfd">        }
        std::cout &lt;&lt; "\n-------------\n";
    }
}</span>

using json = nlohmann::json;
<span style = "background-color:#dfd">void loadConfig(const std::string&amp; filename) {
    std::ifstream file(filename);
    if (!file.is_open()) {
        std::cerr &lt;&lt; "Failed to open configuration file: " &lt;&lt; filename &lt;&lt; std::endl;
        return;</span>
    }
    try {
<span style = "background-color:#dfd">        json j;
        file &gt;&gt; j;
        port = j["Connection"]["port"].get&lt;std::string&gt;();
        baudRate = j["Connection"]["baudRate"].get&lt;int&gt;();</span>

<span style = "background-color:#dfd">        if (port.empty() || baudRate == 0) {
            std::cerr &lt;&lt; "Problem reading settings. Verify that the file has the correct format and value." &lt;&lt; std::endl;</span>
        }
<span style = "background-color:#dfd">    }
    catch (const std::exception&amp; e) {
        std::cerr &lt;&lt; "Error parsing JSON file: " &lt;&lt; e.what() &lt;&lt; std::endl;
    }
}</span></pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>